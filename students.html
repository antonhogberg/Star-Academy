<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Stj√§rnakademiens elever</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    function setViewportHeight() {
      let vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    window.addEventListener('resize', setViewportHeight);
    window.addEventListener('orientationchange', setViewportHeight);
    setViewportHeight();

    window.shareExport = async function () {
      console.log('shareExport called');
      const exportStatus = document.getElementById("exportStatus");
      const popup = document.getElementById("studentPopup");
      const popupMessage = document.getElementById("studentPopupMessage");
      const lang = localStorage.getItem('language') || 'sv';
      try {
        exportStatus.style.display = "block";
        exportStatus.textContent = window.translations[lang].creatingLink;

        const studentsData = JSON.parse(localStorage.getItem("starAcademyStudents")) || { students: {}, currentStudent: "" };
        const current = studentsData.currentStudent;
        if (!current || !studentsData.students[current]) {
          console.warn('No current student selected');
          return;
        }

        const dataToExport = {
          name: current,
          data: studentsData.students[current]
        };

        const response = await fetch('https://firestore.googleapis.com/v1/projects/stjarnakademien-6b272/databases/(default)/documents/exports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fields: {
              name: { stringValue: dataToExport.name },
              data: { mapValue: { fields: convertToFirestoreFields(dataToExport.data) } }
            }
          })
        });

        if (!response.ok) {
          throw new Error('Failed to save to Firestore');
        }

        const docData = await response.json();
        const docId = docData.name.split('/').pop();
        const link = `${window.location.origin}/Star-Academy/index.html?code=${docId}`;

        // Generate QR code with qrcode.js
        const qrCanvas = document.getElementById("qrCodeCanvas");
        if (qrCanvas) {
          qrCanvas.innerHTML = ''; // Clear previous QR code
          new QRCode(qrCanvas, {
            text: link,
            width: 150,
            height: 150,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
          console.log('QR code generated with link:', link);
        }

        if (navigator.share && navigator.canShare({ url: link })) {
          await navigator.share({ title: "Elevdata", url: link });
        } else {
          await navigator.clipboard.writeText(link);
          const starSVG = '<svg class="popup-star" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';
          popupMessage.innerHTML = `${starSVG} ${window.translations[lang].copyLinkSuccess} ${starSVG}`;
          popup.style.display = 'flex';
          popup.className = 'student-popup show';
          setTimeout(() => {
            popup.className = 'student-popup';
            setTimeout(() => { popup.style.display = 'none'; }, 500);
          }, 3000);
        }
      } catch (error) {
        console.error('shareExport error:', error);
        alert(window.translations[lang].error);
      } finally {
        exportStatus.style.display = "none";
      }
    };

    function convertToFirestoreFields(obj) {
      const fields = {};
      for (const [key, value] of Object.entries(obj)) {
        if (typeof value === 'string') {
          fields[key] = { stringValue: value };
        } else if (typeof value === 'object' && value !== null) {
          fields[key] = { mapValue: { fields: convertToFirestoreFields(value) } };
        }
      }
      return fields;
    }

    function openExportPopup() {
      const popup = document.getElementById("exportQrPopup");
      if (popup) {
        popup.style.display = 'flex';
        popup.className = 'student-popup show';
        console.log('Export QR popup opened');
      }
    }

    function closeExportPopup() {
      const popup = document.getElementById("exportQrPopup");
      if (popup) {
        popup.className = 'student-popup';
        setTimeout(() => { popup.style.display = 'none'; }, 500);
        console.log('Export QR popup closed');
      }
    }
  </script>
</head>
<body>
  <div class="piano-menu" id="menuButton" aria-expanded="false" aria-controls="main-menu">
    <div class="white-key"></div>
    <div class="white-key"></div>
    <div class="white-key"></div>
    <div class="black-key top"></div>
    <div class="black-key bottom"></div>
  </div>
  <nav id="menu-placeholder"></nav>
  <div class="student-manager" style="text-align: center;">
    <h1 id="studentsPageTitle" class="students-title" data-translate="studentManager"></h1>

    <div id="addStudentLabel" class="field-label" data-translate="addStudentLabel"></div>
    <div class="input-button-container">
      <div class="input-group">
        <input type="text" id="newStudentName">
        <button id="addStudentButton" onclick="addStudent()" data-translate="addButton"></button>
      </div>
    </div>

    <div id="studentsLabel" class="field-label" data-translate="studentsLabel"></div>
    <div class="dropdown-container">
      <select id="studentSelect" onchange="switchStudent()" style="padding: 10px; font-size: 16px;"></select>
    </div>

    <div class="notes-wrapper">
      <div class="notes-container">
        <div id="notesLabel" class="field-label" data-translate="notesLabel"></div>
        <div class="notes-button-container">
          <textarea id="studentNotes" rows="5"></textarea>
        </div>
      </div>
    </div>

    <div class="export-section">
      <h2 id="exportTitle" class="field-label" data-translate="exportTitle"></h2>
      <div class="export-button-container">
        <button id="openExportPopup" onclick="openExportPopup()" data-translate="shareWithQR"></button>
        <p id="exportStatus" class="info-text" data-translate="creatingLink" style="display: none;"></p>
      </div>
    </div>
  </div>
  <div id="studentPopup" class="student-popup">
    <div class="student-popup-content">
      <p id="studentPopupMessage"></p>
    </div>
  </div>
  <div id="exportQrPopup" class="student-popup">
    <div class="student-popup-content">
      <div id="qrCodeCanvas" style="width: 150px; height: 150px; margin-bottom: 10px;"></div>
      <p id="scanQrText" data-translate="scanQRCode"></p>
      <button id="shareButton" onclick="shareExport()" data-translate="shareButton"></button>
      <button onclick="closeExportPopup()" data-translate="closeButton"></button>
    </div>
  </div>

  <script src="script.js"></script>
  <script src="students.js"></script>

  <script>
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function saveNotes(silent = false) {
      const studentNotes = document.getElementById('studentNotes');
      const currentStudent = window.studentsData.currentStudent;

      if (!currentStudent || !window.studentsData.students[currentStudent]) {
        if (!silent) alert(window.translations[localStorage.getItem('language') || 'sv'].addStudentNoName);
        return;
      }

      window.studentsData.students[currentStudent].notes = studentNotes.value;
      localStorage.setItem('starAcademyStudents', JSON.stringify(window.studentsData));
      if (!silent) alert('Sparat!');
    }

    const debouncedSaveNotes = debounce(() => saveNotes(true), 500);

    document.addEventListener('DOMContentLoaded', () => {
      const lang = localStorage.getItem('language') || 'sv';
      switchLanguage(lang);

      const newStudentInput = document.getElementById('newStudentName');
      if (newStudentInput) {
        newStudentInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && newStudentInput.value.trim()) addStudent();
        });
      }

      loadNotes();

      const notes = document.getElementById('studentNotes');
      if (notes) {
        notes.addEventListener('input', () => debouncedSaveNotes());
        notes.addEventListener('blur', () => saveNotes(true));
      }
    });

    function loadNotes() {
      const select = document.getElementById('studentSelect');
      const notes = document.getElementById('studentNotes');
      const data = JSON.parse(localStorage.getItem('starAcademyStudents')) || { students: {}, currentStudent: '' };

      updateDropdown();

      const current = data.currentStudent;
      if (current && data.students[current] && data.students[current].notes) {
        notes.value = data.students[current].notes;
      } else {
        notes.value = '';
      }

      if (select && current) select.value = current;
    }

    function switchStudent() {
      const select = document.getElementById('studentSelect');
      const notes = document.getElementById('studentNotes');
      let data = JSON.parse(localStorage.getItem('starAcademyStudents')) || { students: {}, currentStudent: '' };
      const selected = select.value;

      if (selected) {
        data.currentStudent = selected;
        localStorage.setItem('starAcademyStudents', JSON.stringify(data));
        window.studentsData.currentStudent = selected;

        notes.value = data.students[selected]?.notes || '';
      } else {
        data.currentStudent = '';
        localStorage.setItem('starAcademyStudents', JSON.stringify(data));
        window.studentsData.currentStudent = '';
        notes.value = '';
      }
    }
  </script>
</body>
</html>