<!DOCTYPE html>
<html>
<head>
  <title>Test Stj√§rnkartan</title>
  <style>
    body {
      background-image: url('background.jpg');
      background-repeat: repeat-x;
      background-position: center top;
      background-color: #000000;
      margin: 0;
    }
    .star-map-container {
      overflow-x: auto;
      overflow-y: hidden;
      width: 100%;
      height: 600px;
    }
    .star-map-container object {
      width: 2800px;
      height: 600px;
    }
    text {
      font-family: Cochin, Georgia, Arial, sans-serif;
      font-size: 16px;
      fill: #999999;
    }
  </style>
</head>
<body>
  <div class="star-map-container">
    <object id="starMap" type="image/svg+xml" data="star-map.svg"></object>
  </div>
  <script>
    // Star images array
    const starImages = [
      'white-star.png',
      'one-star.png',
      'two-stars.png',
      'three-stars.png',
      'four-stars.png',
      'five-stars.png',
      'six-stars.png'
    ];

    // Progression path mapping: star to next star and corresponding line
    const progressionPath = [
      { star: '1:1:1', nextStar: '2:1:1', line: 'line1' },
      { star: '2:1:1', nextStar: '3:1:1', line: 'line2' },
      { star: '3:1:1', nextStar: '7:1:1', line: 'line3' },
      { star: '7:1:1', nextStar: '1:2:1', line: 'line4' },
      { star: '1:2:1', nextStar: '1:1:2', line: 'line4-3' },
      { star: '1:1:2', nextStar: '5:1:1', line: 'line5' },
      { star: '5:1:1', nextStar: '2:1:2', line: 'line6' },
      { star: '2:1:2', nextStar: '3:1:2', line: 'line7' },
      { star: '3:1:2', nextStar: '6:1:1', line: 'line8' },
      { star: '6:1:1', nextStar: '2:1:3', line: 'line9' },
      { star: '2:1:3', nextStar: '7:1:2', line: 'line10' },
      { star: '7:1:2', nextStar: '1:1:3', line: 'line11' },
      { star: '1:1:3', nextStar: '5:1:2', line: 'line12' },
      { star: '5:1:2', nextStar: '6:1:2', line: 'line13' },
      { star: '6:1:2', nextStar: '1:4:1', line: 'line13-2' },
      { star: '1:4:1', nextStar: '1:1:4', line: 'line13-3' },
      { star: '1:1:4', nextStar: '3:1:3', line: 'line14' },
      { star: '3:1:3', nextStar: '3:1:4', line: 'line15' },
      { star: '3:1:4', nextStar: '7:1:3', line: 'line16' },
      { star: '7:1:3', nextStar: '5:1:3', line: 'line17' },
      { star: '5:1:3', nextStar: '6:1:3', line: 'line18' },
      { star: '6:1:3', nextStar: '4:1:1', line: 'line19' },
      { star: '4:1:1', nextStar: '7:1:4', line: 'line20' },
      { star: '7:1:4', nextStar: '4:1:2', line: 'line21' },
      { star: '4:1:2', nextStar: '5:1:4', line: 'line22' },
      { star: '5:1:4', nextStar: '4:1:3', line: 'line23' },
      { star: '4:1:3', nextStar: '6:1:4', line: 'line24' },
      { star: '6:1:4', nextStar: '4:1:4', line: 'line25' },
      { star: '4:1:4', nextStar: '2:1:4', line: 'line26' }
      // Note: '2:1:4' is the last star, so it doesn't connect to a next star
    ];

    // Wait for the SVG to load
    const objectElement = document.getElementById('starMap');
    objectElement.addEventListener('load', () => {
      let svgDoc = objectElement.contentDocument;
      const checkSvgDoc = setInterval(() => {
        svgDoc = objectElement.contentDocument;
        if (svgDoc) {
          clearInterval(checkSvgDoc);
          initializeSvg(svgDoc);
        } else {
          console.error('SVG document not loaded yet');
        }
      }, 100);
    });

    setTimeout(() => {
      if (!objectElement.contentDocument) {
        console.error('SVG load event did not fire or SVG failed to load. Check file path, server setup, and SVG syntax.');
      }
    }, 10000);

    function initializeSvg(svgDoc) {
      // Initialize all stars
      progressionPath.forEach(({ star, nextStar, line }) => {
        const starElement = svgDoc.getElementById(`star-${star.replace(/:/g, '-')}`);
        const lineElement = line ? svgDoc.getElementById(line) : null;

        if (!starElement) {
          console.error(`Star-${star} not found in SVG`);
          return;
        }

        // Get the initial level from starAcademyStudents in LocalStorage
        const studentsData = JSON.parse(localStorage.getItem('starAcademyStudents')) || { students: {}, currentStudent: '' };
        const progress = studentsData.students[studentsData.currentStudent]?.progress || {};
        const exerciseKey = `exercise${star}`;
        let level = progress[exerciseKey] ? parseInt(progress[exerciseKey]) : 0;
        starElement.setAttributeNS('http://www.w3.org/1999/xlink', 'href', starImages[level]);

        // Apply glow and color based on initial level
        if (lineElement) {
          if (level === 6) {
            lineElement.setAttribute('filter', 'url(#golden-glow)');
            lineElement.style.stroke = '#FFD700';
            lineElement.setAttribute('stroke', '#FFD700');
            console.log(`Initial glow and gold color applied to ${line}:`, lineElement.getAttribute('filter'), lineElement.style.stroke, lineElement.getAttribute('stroke'));
          } else {
            lineElement.removeAttribute('filter');
            lineElement.style.stroke = '#FFFFFF';
            lineElement.setAttribute('stroke', '#FFFFFF');
            console.log(`Initial glow removed and color set to white for ${line}:`, lineElement.getAttribute('filter'), lineElement.style.stroke, lineElement.getAttribute('stroke'));
          }
        }

        // Add click event to the star
        starElement.style.cursor = 'pointer';
        starElement.addEventListener('click', () => {
          // Update the level in starAcademyStudents
          const studentsData = JSON.parse(localStorage.getItem('starAcademyStudents')) || { students: {}, currentStudent: '' };
          const progress = studentsData.students[studentsData.currentStudent]?.progress || {};
          let level = progress[exerciseKey] ? parseInt(progress[exerciseKey]) : 0;
          level = (level + 1) % 7; // Increment and cycle (0 to 6)
          progress[exerciseKey] = level.toString();
          studentsData.students[studentsData.currentStudent].progress = progress;
          localStorage.setItem('starAcademyStudents', JSON.stringify(studentsData));

          // Update the star image
          starElement.setAttributeNS('http://www.w3.org/1999/xlink', 'href', starImages[level]);

          // Apply or remove glow and stroke color based on level
          if (lineElement) {
            if (level === 6) {
              lineElement.setAttribute('filter', 'url(#golden-glow)');
              lineElement.style.stroke = '#FFD700';
              lineElement.setAttribute('stroke', '#FFD700');
              console.log(`Glow and gold color applied to ${line}:`, lineElement.getAttribute('filter'), lineElement.style.stroke, lineElement.getAttribute('stroke'));
            } else {
              lineElement.removeAttribute('filter');
              lineElement.style.stroke = '#FFFFFF';
              lineElement.setAttribute('stroke', '#FFFFFF');
              console.log(`Glow removed and color reverted to white for ${line}:`, lineElement.getAttribute('filter'), lineElement.style.stroke, lineElement.getAttribute('stroke'));
            }
          }
          console.log(`Star-${star} clicked, level: ${level}, glow ${level === 6 ? 'applied' : 'removed'}`);
        });

        // Listen for storage events to sync with other pages
        window.addEventListener('storage', (event) => {
          if (event.key === 'starAcademyStudents') {
            const updatedStudentsData = JSON.parse(event.newValue) || { students: {}, currentStudent: '' };
            const updatedProgress = updatedStudentsData.students[updatedStudentsData.currentStudent]?.progress || {};
            const updatedLevel = updatedProgress[exerciseKey] ? parseInt(updatedProgress[exerciseKey]) : 0;
            if (updatedLevel !== level) {
              level = updatedLevel;
              starElement.setAttributeNS('http://www.w3.org/1999/xlink', 'href', starImages[level]);
              if (lineElement) {
                if (level === 6) {
                  lineElement.setAttribute('filter', 'url(#golden-glow)');
                  lineElement.style.stroke = '#FFD700';
                  lineElement.setAttribute('stroke', '#FFD700');
                  console.log(`Glow and gold color applied to ${line} (via storage event):`, lineElement.getAttribute('filter'), lineElement.style.stroke, lineElement.getAttribute('stroke'));
                } else {
                  lineElement.removeAttribute('filter');
                  lineElement.style.stroke = '#FFFFFF';
                  lineElement.setAttribute('stroke', '#FFFFFF');
                  console.log(`Glow removed and color reverted to white for ${line} (via storage event):`, lineElement.getAttribute('filter'), lineElement.style.stroke, lineElement.getAttribute('stroke'));
                }
              }
              console.log(`Star-${star} updated via storage event, level: ${level}, glow ${level === 6 ? 'applied' : 'removed'}`);
            }
          }
        });
      });
    }
  </script>
</body>
</html>