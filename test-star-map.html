<!DOCTYPE html>
<html>
<head>
  <title>Test StjÃ¤rnkartan</title>
  <style>
    body {
      background-image: url('background.jpg');
      background-repeat: repeat-x;
      background-position: center top;
      background-color: #000000;
      margin: 0;
    }
    .star-map-container {
      overflow-x: auto;
      overflow-y: hidden;
      width: 100%;
      height: 600px;
    }
    .star-map-container object {
      width: 2800px;
      height: 600px;
    }
    text {
      font-family: Cochin, Georgia, Arial, sans-serif;
      font-size: 16px;
      fill: #999999;
    }
    /* Congratulatory animation styles */
    .congratulations-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 1s ease-in-out;
    }
    .congratulations-message {
      background: #000000;
      border: 2px solid #ffd700;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      color: #ffd700;
      font-family: Cochin, Georgia, Arial, sans-serif;
      font-size: 24px;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
      animation: pulse 2s infinite;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 215, 0, 0.7); }
      50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(255, 215, 0, 1); }
      100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 215, 0, 0.7); }
    }
  </style>
</head>
<body>
  <div class="star-map-container">
    <object id="starMap" type="image/svg+xml" data="star-map.svg"></object>
  </div>
  <!-- Congratulatory overlay -->
  <div class="congratulations-overlay" id="congratulationsOverlay">
    <div class="congratulations-message">
      Congratulations! Youâ€™ve completed the Star Map! ðŸŒŸ
    </div>
  </div>
  <script>
    // Star images array
    const starImages = [
      'white-star.png',
      'one-star.png',
      'two-stars.png',
      'three-stars.png',
      'four-stars.png',
      'five-stars.png',
      'six-stars.png'
    ];

    // Progression path mapping: star to next star and corresponding lines
    const progressionPath = [
      { star: '1:1:1', nextStar: '2:1:1', lines: ['line1'] },
      { star: '2:1:1', nextStar: '3:1:1', lines: ['line2'] },
      { star: '3:1:1', nextStar: '7:1:1', lines: ['line3'] },
      { star: '7:1:1', nextStar: '1:2:1', lines: ['line4', 'line4-2'] },
      { star: '1:2:1', nextStar: '1:1:2', lines: ['line4-3'] },
      { star: '1:1:2', nextStar: '5:1:1', lines: ['line5'] },
      { star: '5:1:1', nextStar: '2:1:2', lines: ['line6'] },
      { star: '2:1:2', nextStar: '3:1:2', lines: ['line7'] },
      { star: '3:1:2', nextStar: '6:1:1', lines: ['line8'] },
      { star: '6:1:1', nextStar: '2:1:3', lines: ['line9'] },
      { star: '2:1:3', nextStar: '7:1:2', lines: ['line10'] },
      { star: '7:1:2', nextStar: '1:1:3', lines: ['line11'] },
      { star: '1:1:3', nextStar: '5:1:2', lines: ['line12'] },
      { star: '5:1:2', nextStar: '6:1:2', lines: ['line13'] },
      { star: '6:1:2', nextStar: '1:4:1', lines: ['line14', 'line14-2'] },
      { star: '1:4:1', nextStar: '1:1:4', lines: ['line14-3'] },
      { star: '1:1:4', nextStar: '3:1:3', lines: ['line15'] },
      { star: '3:1:3', nextStar: '3:1:4', lines: ['line16'] },
      { star: '3:1:4', nextStar: '7:1:3', lines: ['line17'] },
      { star: '7:1:3', nextStar: '5:1:3', lines: ['line18'] },
      { star: '5:1:3', nextStar: '6:1:3', lines: ['line19'] },
      { star: '6:1:3', nextStar: '4:1:1', lines: ['line20'] },
      { star: '4:1:1', nextStar: '7:1:4', lines: ['line21'] },
      { star: '7:1:4', nextStar: '4:1:2', lines: ['line22'] },
      { star: '4:1:2', nextStar: '5:1:4', lines: ['line23'] },
      { star: '5:1:4', nextStar: '4:1:3', lines: ['line24'] },
      { star: '4:1:3', nextStar: '6:1:4', lines: ['line25'] },
      { star: '6:1:4', nextStar: '4:1:4', lines: ['line26'] },
      { star: '4:1:4', nextStar: '2:1:4', lines: ['line27'] },
      { star: '2:1:4', nextStar: null, lines: [] }
    ];

    // Wait for the SVG to load
    const objectElement = document.getElementById('starMap');
    objectElement.addEventListener('load', () => {
      let svgDoc = objectElement.contentDocument;
      const checkSvgDoc = setInterval(() => {
        svgDoc = objectElement.contentDocument;
        if (svgDoc) {
          clearInterval(checkSvgDoc);
          initializeSvg(svgDoc);
        } else {
          console.error('SVG document not loaded yet');
        }
      }, 100);
    });

    setTimeout(() => {
      if (!objectElement.contentDocument) {
        console.error('SVG load event did not fire or SVG failed to load. Check file path, server setup, and SVG syntax.');
      }
    }, 10000);

    function initializeSvg(svgDoc) {
      // Initialize all stars
      progressionPath.forEach(({ star, nextStar, lines }) => {
        const starElement = svgDoc.getElementById(`star-${star.replace(/:/g, '-')}`);
        const lineElements = lines.map(line => svgDoc.getElementById(line)).filter(line => line);

        if (!starElement) {
          console.error(`Star-${star} not found in SVG`);
          return;
        }

        // Get the initial level from starAcademyStudents in LocalStorage
        const studentsData = JSON.parse(localStorage.getItem('starAcademyStudents')) || { students: {}, currentStudent: '' };
        const progress = studentsData.students[studentsData.currentStudent]?.progress || {};
        const exerciseKey = `exercise${star}`;
        let level = progress[exerciseKey] ? parseInt(progress[exerciseKey]) : 0;
        starElement.setAttributeNS('http://www.w3.org/1999/xlink', 'href', starImages[level]);

        // Apply glow and color based on initial level
        lineElements.forEach(lineElement => {
          if (level === 6) {
            lineElement.setAttribute('filter', 'url(#golden-glow)');
            lineElement.style.stroke = '#FFD700';
            lineElement.setAttribute('stroke', '#FFD700');
            console.log(`Initial glow and gold color applied to ${lineElement.id}:`, lineElement.getAttribute('filter'), lineElement.style.stroke, lineElement.getAttribute('stroke'));
          } else {
            lineElement.removeAttribute('filter');
            lineElement.style.stroke = '#FFFFFF';
            lineElement.setAttribute('stroke', '#FFFFFF');
            console.log(`Initial glow removed and color set to white for ${lineElement.id}:`, lineElement.getAttribute('filter'), lineElement.style.stroke, lineElement.getAttribute('stroke'));
          }
        });

        // Check if all stars are at level 6 on initial load
        const allStarsAtSix = progressionPath.every(({ star }) => {
          const studentsData = JSON.parse(localStorage.getItem('starAcademyStudents')) || { students: {}, currentStudent: '' };
          const progress = studentsData.students[studentsData.currentStudent]?.progress || {};
          const exerciseKey = `exercise${star}`;
          return (progress[exerciseKey] ? parseInt(progress[exerciseKey]) : 0) === 6;
        });
        if (allStarsAtSix) {
          const overlay = document.getElementById('congratulationsOverlay');
          overlay.style.display = 'flex';
          setTimeout(() => {
            overlay.style.display = 'none';
          }, 5000);
        }

        // Add click event to the star
        starElement.style.cursor = 'pointer';
        starElement.addEventListener('click', () => {
          // Update the level in starAcademyStudents
          const studentsData = JSON.parse(localStorage.getItem('starAcademyStudents')) || { students: {}, currentStudent: '' };
          const progress = studentsData.students[studentsData.currentStudent]?.progress || {};
          let level = progress[exerciseKey] ? parseInt(progress[exerciseKey]) : 0;
          level = (level + 1) % 7; // Increment and cycle (0 to 6)
          progress[exerciseKey] = level.toString();
          studentsData.students[studentsData.currentStudent].progress = progress;
          localStorage.setItem('starAcademyStudents', JSON.stringify(studentsData));

          // Animate the change (fade effect)
          starElement.style.opacity = '0';
          setTimeout(() => {
            starElement.setAttributeNS('http://www.w3.org/1999/xlink', 'href', starImages[level]);
            starElement.style.opacity = '1';
          }, 300);

          // Apply or remove glow and stroke color based on level
          lineElements.forEach(lineElement => {
            if (level === 6) {
              lineElement.setAttribute('filter', 'url(#golden-glow)');
              lineElement.style.stroke = '#FFD700';
              lineElement.setAttribute('stroke', '#FFD700');
              console.log(`Glow and gold color applied to ${lineElement.id}:`, lineElement.getAttribute('filter'), lineElement.style.stroke, lineElement.getAttribute('stroke'));
            } else {
              lineElement.removeAttribute('filter');
              lineElement.style.stroke = '#FFFFFF';
              lineElement.setAttribute('stroke', '#FFFFFF');
              console.log(`Glow removed and color reverted to white for ${lineElement.id}:`, lineElement.getAttribute('filter'), lineElement.style.stroke, lineElement.getAttribute('stroke'));
            }
          });

          // Check if all stars are at level 6 for the congratulatory animation
          const allStarsAtSix = progressionPath.every(({ star }) => {
            const studentsData = JSON.parse(localStorage.getItem('starAcademyStudents')) || { students: {}, currentStudent: '' };
            const progress = studentsData.students[studentsData.currentStudent]?.progress || {};
            const exerciseKey = `exercise${star}`;
            return (progress[exerciseKey] ? parseInt(progress[exerciseKey]) : 0) === 6;
          });
          if (allStarsAtSix) {
            const overlay = document.getElementById('congratulationsOverlay');
            overlay.style.display = 'flex';
            setTimeout(() => {
              overlay.style.display = 'none';
            }, 5000);
          }

          console.log(`Star-${star} clicked, level: ${level}, glow ${level === 6 ? 'applied' : 'removed'}`);
        });

        // Listen for storage events to sync with other pages
        window.addEventListener('storage', (event) => {
          if (event.key === 'starAcademyStudents') {
            const updatedStudentsData = JSON.parse(event.newValue) || { students: {}, currentStudent: '' };
            const updatedProgress = updatedStudentsData.students[updatedStudentsData.currentStudent]?.progress || {};
            const updatedLevel = updatedProgress[exerciseKey] ? parseInt(updatedProgress[exerciseKey]) : 0;
            if (updatedLevel !== level) {
              level = updatedLevel;
              // Animate the change (fade effect)
              starElement.style.opacity = '0';
              setTimeout(() => {
                starElement.setAttributeNS('http://www.w3.org/1999/xlink', 'href', starImages[level]);
                starElement.style.opacity = '1';
              }, 300);

              lineElements.forEach(lineElement => {
                if (level === 6) {
                  lineElement.setAttribute('filter', 'url(#golden-glow)');
                  lineElement.style.stroke = '#FFD700';
                  lineElement.setAttribute('stroke', '#FFD700');
                  console.log(`Glow and gold color applied to ${lineElement.id} (via storage event):`, lineElement.getAttribute('filter'), lineElement.style.stroke, lineElement.getAttribute('stroke'));
                } else {
                  lineElement.removeAttribute('filter');
                  lineElement.style.stroke = '#FFFFFF';
                  lineElement.setAttribute('stroke', '#FFFFFF');
                  console.log(`Glow removed and color reverted to white for ${lineElement.id} (via storage event):`, lineElement.getAttribute('filter'), lineElement.style.stroke, lineElement.getAttribute('stroke'));
                }
              });

              // Check for congratulatory animation on storage event
              const allStarsAtSix = progressionPath.every(({ star }) => {
                const studentsData = JSON.parse(localStorage.getItem('starAcademyStudents')) || { students: {}, currentStudent: '' };
                const progress = studentsData.students[studentsData.currentStudent]?.progress || {};
                const exerciseKey = `exercise${star}`;
                return (progress[exerciseKey] ? parseInt(progress[exerciseKey]) : 0) === 6;
              });
              if (allStarsAtSix) {
                const overlay = document.getElementById('congratulationsOverlay');
                overlay.style.display = 'flex';
                setTimeout(() => {
                  overlay.style.display = 'none';
                }, 5000);
              }

              console.log(`Star-${star} updated via storage event, level: ${level}, glow ${level === 6 ? 'applied' : 'removed'}`);
            }
          }
        });
      });
    }
  </script>
</body>
</html>